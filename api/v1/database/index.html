<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
     <script>
        (function () {
            const urlParams = new URLSearchParams(window.location.search);
            const sqlQuery = urlParams.get('sqlquery');
            if (!sqlQuery) {
                setTimeout(() => respond({ error: "sqlquery query parameter is required" }), 0);
                return;
            }

            getLatestDatabaseUrl().then(dbUrl => {
                return loadDB(dbUrl);
            }).then(db => {
                try {
                    const results = db.exec(sqlQuery);
                    respond({ results });
                } catch (e) {
                    respond({ error: e.message });
                }
            }).catch(e => {
                respond({ error: e.message });
            });

            async function getLatestDatabaseUrl() {
                const response = await fetch('https://api.github.com/repos/gillesdami/yugioh-superdb/releases/latest');
                const release = await response.json();
                const version = release.tag_name;

                return `https://cdn.jsdelivr.net/gh/gillesdami/yugioh-superdb@${version}/yugioh-superdb.zip`;
            }

            async function loadDB(url) {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch database: ${response.statusText}`);
                }

                const zipArrayBuffer = await response.arrayBuffer();
                // Unzip the database file
                const zip = new JSZip();
                const zipContent = await zip.loadAsync(zipArrayBuffer);
                const dbFile = zipContent.files[`yugioh-superdb.sqlite`];
                const arrayBuffer = await dbFile.async("arraybuffer");
                return new SQL.Database(new Uint8Array(arrayBuffer));
            }

            function respond(data) {
                document.body.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
        })();
    </script>
</head>
<body>
    <noscript>Please enable JavaScript to use the API</noscript>
</body>
</html>