<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
     <script>
        (function () {
            const urlParams = new URLSearchParams(window.location.search);
            const sqlQuery = urlParams.get('sqlquery');
            if (!sqlQuery) {
                setTimeout(() => respond({ error: "sqlquery query parameter is required" }), 0);
                return;
            }

            const zip = new JSZip();

            Promise.all([
                initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` }),
                fetch('https://api.github.com/repos/gillesdami/yugioh-superdb/releases/latest')
                    .then(response => response.json())
                    .then(release => release.tag_name)
                    .then(releaseTag => fetch(`https://cdn.statically.io/gh/gillesdami/yugioh-superdb/${releaseTag}/yugioh-superdb.zip`))
                    .then(response => response.arrayBuffer())
                    .then(zipArrayBuffer => zip.loadAsync(zipArrayBuffer))
                    .then(zipContent => zipContent.files[`yugioh-superdb.sqlite`].async("arraybuffer"))
            ])
            .then(([SQL, arrayBuffer]) => new SQL.Database(new Uint8Array(arrayBuffer)))
            .then(db => respond(db.exec(sqlQuery)))
            .catch(e => {
                respond({ error: e.message });
                throw e;
            });

            function respond(data) {
                document.body.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
        })();
    </script>
</head>
<body>
    <noscript>Please enable JavaScript to use the API</noscript>
</body>
</html>